<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GainLab ‚Äî Agent's Eyes for Financial Charts</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#08081a;--bg2:#0d0d1f;--card:#12122b;--bdr:#1e1e3d;--bdr-a:#00d4aa55;--up:#00d4aa;--dn:#ff4757;--acc:#5b8ff9;--gold:#ffc233;--purp:#7c4dff;--txt:#e8e8f0;--dim:#8888aa;--mut:#555577;--grid:#1a1a35;--f:'DM Sans',sans-serif;--m:'JetBrains Mono',monospace}
    *{margin:0;padding:0;box-sizing:border-box}body{background:var(--bg);color:var(--txt);font-family:var(--f);min-height:100vh}
    .hero{text-align:center;padding:56px 20px 36px;position:relative}
    .hero::before{content:'';position:absolute;top:-40%;left:50%;transform:translateX(-50%);width:700px;height:700px;background:radial-gradient(ellipse,#00d4aa08,transparent 70%);pointer-events:none}
    .logo{font-size:3em;font-weight:700;letter-spacing:-1px}.logo .g{color:var(--up)}
    .sub{font-size:1.1em;color:var(--dim);margin:4px 0;font-weight:500}
    .tag{font-size:.88em;color:var(--mut);font-style:italic;margin-bottom:22px}
    .stats{display:flex;gap:22px;justify-content:center;flex-wrap:wrap;margin-bottom:28px;font-family:var(--m);font-size:.82em}
    .stats .s{display:flex;align-items:center;gap:5px}.stats .d{width:7px;height:7px;border-radius:50%;display:inline-block}
    .stats .d.g{background:var(--up);box-shadow:0 0 6px var(--up)}.stats .d.b{background:var(--acc);box-shadow:0 0 6px var(--acc)}.stats .d.y{background:var(--gold);box-shadow:0 0 6px var(--gold)}
    .stats .n{color:var(--txt);font-weight:600}.stats .l{color:var(--mut)}
    .tnav{display:flex;justify-content:center;gap:4px;padding:0 16px;margin-bottom:18px}
    .tb{background:0;border:1px solid var(--bdr);color:var(--dim);padding:9px 18px;border-radius:7px;font-family:var(--f);font-size:.84em;font-weight:600;cursor:pointer;transition:.2s}
    .tb:hover{background:#1a1a3a;color:var(--txt)}.tb.on{background:var(--card);border-color:var(--bdr-a);color:var(--up)}
    .demo{max-width:1060px;margin:0 auto;padding:0 16px}
    .pnl{display:none;background:var(--card);border:1px solid var(--bdr);border-radius:14px;overflow:hidden}.pnl.on{display:block}
    .ctl{display:flex;gap:8px;padding:12px 16px;flex-wrap:wrap;align-items:center;border-bottom:1px solid var(--bdr)}
    .ctl select,.ctl button{background:var(--bg);color:var(--txt);border:1px solid var(--bdr);padding:6px 12px;border-radius:6px;font-family:var(--f);font-size:.82em;cursor:pointer;transition:.2s}
    .ctl select:hover,.ctl button:hover{border-color:var(--up)}
    .ctl .go{background:var(--up);color:var(--bg);font-weight:700;border:none;padding:6px 16px}.ctl .go:hover{opacity:.85}
    .ctl .sp{flex:1}.ctl .st{font-family:var(--m);font-size:.74em;color:var(--mut)}
    .cw{width:100%;height:480px;padding:8px}
    .code-s{max-width:1060px;margin:38px auto 0;padding:0 16px}
    .code-s h3{font-size:.82em;color:var(--dim);margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
    .cb{background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:16px 20px;font-family:var(--m);font-size:.78em;line-height:1.6;color:var(--dim);overflow-x:auto;white-space:pre}
    .cb .k{color:var(--purp)}.cb .s{color:var(--up)}.cb .c{color:var(--mut);font-style:italic}.cb .n{color:var(--gold)}
    .feats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;max-width:1060px;margin:40px auto 0;padding:0 16px}
    .ft{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:20px 16px;transition:.2s}
    .ft:hover{border-color:var(--bdr-a);transform:translateY(-2px)}
    .ft .i{font-size:1.5em;margin-bottom:6px}.ft h4{font-size:.9em;margin-bottom:3px}.ft p{font-size:.76em;color:var(--mut);line-height:1.5}
    .ft .tg{display:inline-block;margin-top:7px;font-size:.66em;font-family:var(--m);padding:2px 7px;border-radius:4px}
    .ft .tg.lv{background:#00d4aa18;color:var(--up)}.ft .tg.sn{background:#5b8ff918;color:var(--acc)}
    .arch-s{max-width:1060px;margin:40px auto 0;padding:0 16px}
    .arch-s h3{font-size:.82em;color:var(--dim);margin-bottom:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
    .arch{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:22px;font-family:var(--m);font-size:.76em;line-height:1.8;color:var(--dim);white-space:pre;overflow-x:auto}
    .ftr{text-align:center;padding:48px 20px 28px;color:var(--mut);font-size:.82em}
    .ftr a{color:var(--acc);text-decoration:none}.ftr a:hover{text-decoration:underline}.ftr .lk{margin-bottom:8px}.ftr .lk a{margin:0 10px}
    @media(max-width:640px){.logo{font-size:2.2em}.tb{padding:7px 10px;font-size:.76em}.cw{height:340px!important}.feats{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>

<div class="hero">
  <div class="logo">ü¶û <span class="g">Gain</span>Lab</div>
  <div class="sub">Agent's Eyes for Financial Charts</div>
  <div class="tag">Agents can analyze, but they can't draw charts. GainLab gives agents eyes.</div>
  <div class="stats">
    <div class="s"><span class="d g"></span><span class="n">7</span><span class="l">tools</span></div>
    <div class="s"><span class="d b"></span><span class="n">4</span><span class="l">markets</span></div>
    <div class="s"><span class="d y"></span><span class="n">275</span><span class="l">tests</span></div>
  </div>
</div>

<div class="tnav">
  <button class="tb on" onclick="sw('kline',this)">üìä K-Line</button>
  <button class="tb" onclick="sw('vp',this)">üìä Volume Profile</button>
  <button class="tb" onclick="sw('indicators',this)">üîß Indicators</button>
  <button class="tb" onclick="sw('overlay',this)">üìà Overlay</button>
  <button class="tb" onclick="sw('fundamentals',this)">üìã Fundamentals</button>
  <button class="tb" onclick="sw('wrb',this)">üéØ WRB Scoring</button>
  <button class="tb" onclick="sw('heatmap',this)">üî• Heatmap</button>
  <button class="tb" onclick="sw('corr',this)">üîó Correlation</button>
</div>

<div class="demo">
  <div class="pnl on" id="p-kline">
    <div class="ctl">
      <select id="kl-s"><option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option><option>BNBUSDT</option></select>
      <select id="kl-t"><option value="1h">1H</option><option value="4h">4H</option><option value="1d" selected>1D</option><option value="1w">1W</option></select>
      <select id="kl-l"><option>60</option><option selected>100</option><option>200</option></select>
      <button class="go" onclick="lkl()">Load</button><div class="sp"></div><span class="st" id="kl-st">‚Äî</span>
    </div>
    <div class="cw" id="c-kline"></div>
  </div>

  <div class="pnl" id="p-vp">
    <div class="ctl">
      <select id="vp-s"><option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option><option>BNBUSDT</option></select>
      <select id="vp-t"><option value="1h">1H</option><option value="4h">4H</option><option value="1d" selected>1D</option></select>
      <select id="vp-l"><option>60</option><option selected>120</option><option>200</option></select>
      <select id="vp-r"><option value="12">12 rows</option><option value="24" selected>24 rows</option><option value="48">48 rows</option></select>
      <button class="go" onclick="lvp()">Load</button><div class="sp"></div><span class="st" id="vp-st">‚Äî</span>
    </div>
    <div class="cw" id="c-vp" style="height:520px"></div>
  </div>

  <div class="pnl" id="p-indicators">
    <div class="ctl">
      <select id="in-s"><option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option></select>
      <select id="in-i" multiple size="4" style="min-width:130px"><option value="MA" selected>MA</option><option value="VWAP">VWAP</option><option value="RSI" selected>RSI</option><option value="MACD">MACD</option><option value="BOLL">Bollinger</option><option value="ATR">ATR</option></select>
      <button class="go" onclick="lind()">Load</button><div class="sp"></div><span class="st" id="in-st">‚Äî</span>
    </div>
    <div class="cw" id="c-indicators" style="height:560px"></div>
  </div>

  <div class="pnl" id="p-overlay">
    <div class="ctl">
      <select id="ov-1"><option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option><option>BNBUSDT</option></select>
      <span style="color:var(--mut);font-size:.8em">vs</span>
      <select id="ov-2"><option>ETHUSDT</option><option>BTCUSDT</option><option>SOLUSDT</option><option>BNBUSDT</option></select>
      <select id="ov-d"><option value="90">3M</option><option value="180" selected>6M</option><option value="365">1Y</option></select>
      <button class="go" onclick="lov()">Compare</button><div class="sp"></div><span class="st" id="ov-st">‚Äî</span>
    </div>
    <div class="cw" id="c-overlay"></div>
  </div>

  <div class="pnl" id="p-fundamentals">
    <div class="ctl">
      <select id="fn-m"><option value="standard" selected>Standard</option><option value="dcf">DCF Gauge</option><option value="estimates">Analyst Estimates</option></select>
      <select id="fn-s" style="display:none"><option>AAPL</option><option>MSFT</option><option>GOOGL</option><option>TSLA</option><option>AMZN</option><option>NVDA</option></select>
      <button class="go" onclick="lfun()">Load</button><div class="sp"></div><span class="st" id="fn-st">Sample data ‚Äî API keys required for live</span>
    </div>
    <div class="cw" id="c-fundamentals"></div>
  </div>

  <div class="pnl" id="p-wrb">
    <div class="ctl">
      <select id="wrb-s"><option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option><option>BNBUSDT</option></select>
      <select id="wrb-t"><option value="1h">1H</option><option value="4h">4H</option><option value="1d" selected>1D</option></select>
      <select id="wrb-l"><option>100</option><option selected>150</option><option>200</option></select>
      <button class="go" onclick="lwrb()">Analyze</button><div class="sp"></div><span class="st" id="wrb-st">‚Äî</span>
    </div>
    <div class="cw" id="c-wrb" style="height:540px"></div>
  </div>

  <div class="pnl" id="p-heatmap">
    <div class="ctl">
      <select id="hm-m"><option value="crypto" selected>Crypto</option></select>
      <select id="hm-l"><option value="30">Top 30</option><option value="50" selected>Top 50</option><option value="100">Top 100</option></select>
      <select id="hm-v"><option value="1000000" selected>Vol > $1M</option><option value="5000000">Vol > $5M</option><option value="10000000">Vol > $10M</option></select>
      <button class="go" onclick="lhm()">Load</button><div class="sp"></div><span class="st" id="hm-st">Live from Binance ‚Äî no API key needed</span>
    </div>
    <div class="cw" id="c-heatmap" style="height:580px"></div>
  </div>

  <div class="pnl" id="p-corr">
    <div class="ctl">
      <select id="cr-a1"><option>BTCUSDT</option><option>ETHUSDT</option><option>SOLUSDT</option><option>BNBUSDT</option><option>DOGEUSDT</option><option>XRPUSDT</option><option>ADAUSDT</option><option>AVAXUSDT</option></select>
      <select id="cr-a2"><option>ETHUSDT</option><option>BTCUSDT</option><option>SOLUSDT</option><option>BNBUSDT</option><option>DOGEUSDT</option><option>XRPUSDT</option><option>ADAUSDT</option><option>AVAXUSDT</option></select>
      <select id="cr-a3"><option>SOLUSDT</option><option>BTCUSDT</option><option>ETHUSDT</option><option>BNBUSDT</option><option>DOGEUSDT</option><option>XRPUSDT</option><option>ADAUSDT</option><option>AVAXUSDT</option></select>
      <select id="cr-a4"><option value="">‚Äî none ‚Äî</option><option>BNBUSDT</option><option>DOGEUSDT</option><option>XRPUSDT</option><option>ADAUSDT</option><option>AVAXUSDT</option><option>BTCUSDT</option><option>ETHUSDT</option></select>
      <select id="cr-d"><option value="60">60 days</option><option value="90" selected>90 days</option><option value="180">180 days</option></select>
      <button class="go" onclick="lcr()">Calculate</button><div class="sp"></div><span class="st" id="cr-st">Pearson correlation from daily returns</span>
    </div>
    <div class="cw" id="c-corr" style="height:520px"></div>
  </div>
</div>

<div class="code-s">
  <h3>Use with any MCP Client</h3>
  <div class="cb"><span class="c">// Ask your AI agent:</span>
"Draw a BTC daily chart with RSI and MACD"
"Analyze AAPL with WRB/HG scoring"
"Show me a DCF valuation for MSFT"

<span class="c">// Or call MCP tools directly:</span>
{
  <span class="s">"tool"</span>: <span class="s">"gainlab_indicators"</span>,
  <span class="s">"symbol"</span>: <span class="s">"BTCUSDT"</span>,
  <span class="s">"market"</span>: <span class="s">"crypto"</span>,
  <span class="s">"indicators"</span>: [<span class="s">"MA"</span>, <span class="s">"RSI"</span>, <span class="s">"MACD"</span>]
}
{
  <span class="s">"tool"</span>: <span class="s">"gainlab_wrb_scoring"</span>,
  <span class="s">"symbol"</span>: <span class="s">"BTCUSDT"</span>,
  <span class="s">"market"</span>: <span class="s">"crypto"</span>,
  <span class="s">"sensitivity"</span>: <span class="n">1.5</span>
}</div>
</div>

<div class="feats">
  <div class="ft"><div class="i">üìä</div><h4>K-Line Charts</h4><p>Professional candlestick + volume. Crypto, US stocks, A-shares, commodities.</p><span class="tg lv">‚úÖ live</span></div>
  <div class="ft"><div class="i">üîß</div><h4>Technical Indicators</h4><p>MA, EMA, RSI, MACD, Bollinger, KDJ. Dynamic multi-panel layout.</p><span class="tg lv">‚úÖ live</span></div>
  <div class="ft"><div class="i">üìà</div><h4>Multi-Asset Overlay</h4><p>Compare 2-6 assets. Normalized % change. Cross-market.</p><span class="tg lv">‚úÖ live</span></div>
  <div class="ft"><div class="i">üìã</div><h4>Fundamentals</h4><p>Revenue, margins, EPS. DCF valuation gauge. Analyst estimates. Peer comparison.</p><span class="tg lv">‚úÖ live</span></div>
  <div class="ft"><div class="i">üéØ</div><h4>WRB/HG Scoring</h4><p>Wide Range Bar + Hidden Gap detection. ABC scoring with Pro signals for entries.</p><span class="tg lv">‚úÖ live</span></div>
  <div class="ft"><div class="i">üìä</div><h4>Volume Profile</h4><p>POC, Value Area, price-volume distribution. Interactive VP chart.</p><span class="tg lv">‚úÖ live</span></div>
  <div class="ft"><div class="i">üìâ</div><h4>VWAP + ATR</h4><p>Institutional VWAP, Anchored VWAP, and ATR volatility.</p><span class="tg lv">‚úÖ live</span></div>
  <div class="ft"><div class="i">üî•</div><h4>Sector Heatmap</h4><p>Finviz-style treemap. Block size = volume, color = 24h change.</p><span class="tg lv">‚úÖ live</span></div>
  <div class="ft"><div class="i">üîó</div><h4>Correlation Matrix</h4><p>N√óN Pearson correlation. Cross-market asset comparison.</p><span class="tg lv">‚úÖ live</span></div>
  <div class="ft"><div class="i">üìÖ</div><h4>Financial Calendar</h4><p>Earnings, FOMC, CPI, token unlocks.</p><span class="tg sn">phase 3</span></div>
  <div class="ft"><div class="i">‚ö°</div><h4>Funding Rate</h4><p>Crypto perpetual rates across exchanges.</p><span class="tg sn">phase 3</span></div>
  <div class="ft"><div class="i">üîî</div><h4>Smart Alerts</h4><p>Price, event & indicator alerts.</p><span class="tg sn">phase 4</span></div>
</div>

<div class="arch-s">
  <h3>Architecture</h3>
  <div class="arch">Agent (Claude / ChatGPT / OpenClaw / custom)
  ‚îÇ MCP Protocol
  ‚ñº
@gainlab/mcp-server
  ‚îú‚îÄ‚îÄ tools/    ‚Üí 7 MCP tools (kline, volume-profile, indicators, overlay, fundamentals, heatmap, wrb-scoring)
  ‚îú‚îÄ‚îÄ data/     ‚Üí 4 markets (Binance ¬∑ FMP ¬∑ EODHD)
  ‚îú‚îÄ‚îÄ render/   ‚Üí ECharts (interactive HTML + server-side PNG)
  ‚îî‚îÄ‚îÄ utils/    ‚Üí TA math (zero deps) + proxy-aware fetch</div>
</div>

<div class="ftr">
  <div class="lk"><a href="https://github.com/Ashersun1207/gainlab-mcp">GitHub</a><a href="https://github.com/Ashersun1207/gainlab-mcp#quick-start">Docs</a><a href="https://github.com/Ashersun1207/gainlab-mcp/blob/main/LICENSE">Apache 2.0</a></div>
  Built by <a href="https://github.com/Ashersun1207">Asher</a> &amp; Êô∫ÊÖßÂç∑Âç∑ ü¶û
</div>

<script>
const U='#00d4aa',D='#ff4757',B='#0d0d1f',G='#1a1a35',T='#e8e8f0',S='#8888aa',P=['#00d4aa','#5b8ff9','#ff4757','#ffc233','#7c4dff'];
const ch={};
function ic(id){if(!ch[id]){ch[id]=echarts.init(document.getElementById(id));window.addEventListener('resize',()=>ch[id]?.resize())}return ch[id]}
function sw(n,el){document.querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));document.querySelectorAll('.pnl').forEach(p=>p.classList.remove('on'));el.classList.add('on');document.getElementById('p-'+n).classList.add('on');if(n==='kline'&&!ch['c-kline'])lkl();if(n==='vp'&&!ch['c-vp'])lvp();if(n==='indicators'&&!ch['c-indicators'])lind();if(n==='overlay'&&!ch['c-overlay'])lov();if(n==='fundamentals'&&!ch['c-fundamentals'])lfun();if(n==='wrb'&&!ch['c-wrb'])lwrb();if(n==='heatmap'&&!ch['c-heatmap'])lhm();if(n==='corr'&&!ch['c-corr'])lcr();setTimeout(()=>{if(ch['c-'+n])ch['c-'+n].resize()},50)}
async function fb(s,i,l){return(await fetch(`https://api.binance.com/api/v3/klines?symbol=${s}&interval=${i}&limit=${l}`)).json()}
function fd(ts,tf){const d=new Date(ts);return(tf.includes('m')||tf==='1h'||tf==='4h')?d.toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):d.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'})}

// VOLUME PROFILE
function calcVP(klines,rows=24,vaP=0.7){
let gH=-Infinity,gL=Infinity;klines.forEach(k=>{gH=Math.max(gH,+k[2]);gL=Math.min(gL,+k[3])});
if(gH===gL){const tv=klines.reduce((a,k)=>a+(+k[5]),0);return{rows:[{pMin:gL,pMax:gH,pMid:gL,vol:tv,bv:0,sv:0}],poc:gL,vah:gH,val:gL}}
const rH=(gH-gL)/rows,vr=[];for(let i=0;i<rows;i++){vr.push({pMin:gL+i*rH,pMax:gL+(i+1)*rH,pMid:gL+(i+.5)*rH,vol:0,bv:0,sv:0})}
let tv=0;klines.forEach(k=>{const h=+k[2],l=+k[3],c=+k[4],o=+k[1],v=+k[5],buy=c>o;tv+=v;
if(h===l){const ri=Math.min(Math.max(0,Math.floor((c-gL)/rH)),rows-1);if(buy)vr[ri].bv+=v;else vr[ri].sv+=v;vr[ri].vol+=v}
else{const sr=Math.max(0,Math.floor((l-gL)/rH)),er=Math.min(rows-1,Math.floor((h-gL)/rH));
for(let r=sr;r<=er;r++){const ol=Math.max(l,vr[r].pMin),oh=Math.min(h,vr[r].pMax),p=Math.max(0,oh-ol)/(h-l),vl=v*p;
if(buy)vr[r].bv+=vl;else vr[r].sv+=vl;vr[r].vol+=vl}}});
let pi=0,mx=0;vr.forEach((r,i)=>{if(r.vol>mx){mx=r.vol;pi=i}});
let cv=vr[pi].vol,lo=pi,hi=pi;const tgt=tv*vaP;
while(cv<tgt&&(lo>0||hi<rows-1)){const bv=lo>0?vr[lo-1].vol:-1,av=hi<rows-1?vr[hi+1].vol:-1;
if(bv>=av&&bv>=0){lo--;cv+=vr[lo].vol}else if(av>=0){hi++;cv+=vr[hi].vol}else break}
return{rows:vr,poc:vr[pi].pMid,vah:vr[hi].pMax,val:vr[lo].pMin,pocIdx:pi,vaLo:lo,vaHi:hi}}

async function lvp(){const s=$('vp-s').value,t=$('vp-t').value,l=+$('vp-l').value,rows=+$('vp-r').value;$('vp-st').textContent='Loading...';
try{const r=await fb(s,t,l),dt=r.map(k=>fd(k[0],t)),oh=r.map(k=>[+k[1],+k[4],+k[3],+k[2]]),v=r.map(k=>+k[5]),vc=r.map(k=>+k[4]>=+k[1]?U+'80':D+'80');
const vp=calcVP(r,rows);const maxV=Math.max(...vp.rows.map(r=>r.vol));
const prLabels=vp.rows.map(r=>r.pMid.toFixed(2));
// Calculate y-axis range from VP rows for alignment
const vpPriceMin=vp.rows[0].pMin,vpPriceMax=vp.rows[vp.rows.length-1].pMax;
const priceMargin=(vpPriceMax-vpPriceMin)*0.02;
const ch=ic('c-vp');
ch.setOption({backgroundColor:B,animation:false,title:{text:`${s} ‚Äî ${t} Volume Profile`,left:'center',textStyle:{color:T,fontSize:15,fontWeight:700}},
tooltip:{trigger:'axis',axisPointer:{type:'cross'},backgroundColor:'#1e1e3d',borderColor:'#2a2a4a',textStyle:{color:T}},
grid:[{left:'6%',right:'30%',top:'8%',height:'55%'},{left:'6%',right:'30%',top:'67%',height:'15%'},{left:'72%',right:'2%',top:'8%',height:'74%'}],
xAxis:[
{type:'category',data:dt,gridIndex:0,axisLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:9},splitLine:{show:false}},
{type:'category',data:dt,gridIndex:1,axisLine:{lineStyle:{color:G}},axisLabel:{show:false},splitLine:{show:false}},
{type:'value',gridIndex:2,axisLine:{lineStyle:{color:G}},axisLabel:{show:false},splitLine:{show:false},max:maxV*1.1}
],
yAxis:[
{type:'value',gridIndex:0,splitLine:{lineStyle:{color:G}},axisLabel:{color:S},min:vpPriceMin-priceMargin,max:vpPriceMax+priceMargin},
{type:'value',gridIndex:1,splitLine:{show:false},axisLabel:{show:false},axisLine:{show:false}},
{type:'category',gridIndex:2,data:prLabels,axisLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:8},splitLine:{show:false}}
],
series:[
{type:'candlestick',data:oh,xAxisIndex:0,yAxisIndex:0,itemStyle:{color:U,color0:D,borderColor:U,borderColor0:D},
markLine:{silent:true,symbol:'none',lineStyle:{width:1.5},data:[
{yAxis:vp.poc,lineStyle:{color:'#fff',type:'solid'},label:{formatter:'POC '+vp.poc.toFixed(2),color:'#fff',fontSize:10}},
{yAxis:vp.vah,lineStyle:{color:'#ffc233',type:'dashed'},label:{formatter:'VAH '+vp.vah.toFixed(2),color:'#ffc233',fontSize:10}},
{yAxis:vp.val,lineStyle:{color:'#ffc233',type:'dashed'},label:{formatter:'VAL '+vp.val.toFixed(2),color:'#ffc233',fontSize:10}}
]},
markArea:{silent:true,data:[[{yAxis:vp.val,itemStyle:{color:'#ffc23312'}},{yAxis:vp.vah}]]}
},
{type:'bar',data:v.map((x,i)=>({value:x,itemStyle:{color:vc[i]}})),xAxisIndex:1,yAxisIndex:1},
{name:'Buy Vol',type:'bar',stack:'vp',data:vp.rows.map((r,i)=>({value:r.bv,itemStyle:{color:i===vp.pocIdx?'#fff':U,borderColor:i===vp.pocIdx?'#fff':'transparent',borderWidth:i===vp.pocIdx?2:0}})),xAxisIndex:2,yAxisIndex:2,barWidth:'60%'},
{name:'Sell Vol',type:'bar',stack:'vp',data:vp.rows.map((r,i)=>({value:r.sv,itemStyle:{color:i===vp.pocIdx?'#ccc':D,borderColor:i===vp.pocIdx?'#fff':'transparent',borderWidth:i===vp.pocIdx?2:0}})),xAxisIndex:2,yAxisIndex:2,barWidth:'60%'}
],
dataZoom:[{type:'inside',xAxisIndex:[0,1]}]
},true);
$('vp-st').textContent=`POC: ${vp.poc.toFixed(2)} | VAH: ${vp.vah.toFixed(2)} | VAL: ${vp.val.toFixed(2)} ¬∑ ${r.length} candles`
}catch(e){$('vp-st').textContent='Error: '+e.message}}

// VWAP helper
function vwap(klines){const r=[];let ctpv=0,cv=0;klines.forEach(k=>{const tp=(+k[2]+ +k[3]+ +k[4])/3;ctpv+=tp*(+k[5]);cv+= +k[5];r.push(cv===0?null:ctpv/cv)});return r}
// ATR helper
function atr(klines,p=14){const tr=[];klines.forEach((k,i)=>{if(!i){tr.push(+k[2]- +k[3])}else{const hl=+k[2]- +k[3],hpc=Math.abs(+k[2]- +klines[i-1][4]),lpc=Math.abs(+k[3]- +klines[i-1][4]);tr.push(Math.max(hl,hpc,lpc))}});
const r=[];let a=0;for(let i=0;i<tr.length;i++){if(i<p-1){r.push(null)}else if(i===p-1){a=tr.slice(0,p).reduce((s,v)=>s+v,0)/p;r.push(a)}else{a=(a*(p-1)+tr[i])/p;r.push(a)}}return r}

// K-LINE
async function lkl(){const s=$('kl-s').value,t=$('kl-t').value,l=+$('kl-l').value;$('kl-st').textContent='Loading...';
try{const r=await fb(s,t,l),dt=r.map(k=>fd(k[0],t)),oh=r.map(k=>[+k[1],+k[4],+k[3],+k[2]]),v=r.map(k=>+k[5]),vc=r.map(k=>+k[4]>=+k[1]?U+'80':D+'80');
ic('c-kline').setOption({backgroundColor:B,animation:false,title:{text:`${s} ‚Äî ${t}`,left:'center',textStyle:{color:T,fontSize:15,fontWeight:700}},tooltip:{trigger:'axis',axisPointer:{type:'cross'},backgroundColor:'#1e1e3d',borderColor:'#2a2a4a',textStyle:{color:T}},grid:[{left:'8%',right:'4%',top:'10%',height:'56%'},{left:'8%',right:'4%',top:'70%',height:'18%'}],xAxis:[{type:'category',data:dt,gridIndex:0,axisLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:10},splitLine:{show:false}},{type:'category',data:dt,gridIndex:1,axisLine:{lineStyle:{color:G}},axisLabel:{show:false},splitLine:{show:false}}],yAxis:[{type:'value',gridIndex:0,splitLine:{lineStyle:{color:G}},axisLabel:{color:S},scale:true},{type:'value',gridIndex:1,splitLine:{show:false},axisLabel:{show:false},axisLine:{show:false}}],series:[{type:'candlestick',data:oh,itemStyle:{color:U,color0:D,borderColor:U,borderColor0:D}},{type:'bar',data:v.map((x,i)=>({value:x,itemStyle:{color:vc[i]}})),xAxisIndex:1,yAxisIndex:1}],dataZoom:[{type:'inside',xAxisIndex:[0,1]}]},true);
const la=r[r.length-1],pc=((+la[4]-+la[1])/+la[1]*100).toFixed(2);$('kl-st').textContent=`Last: ${(+la[4]).toLocaleString()} (${pc>=0?'+':''}${pc}%) ¬∑ ${r.length} candles`}catch(e){$('kl-st').textContent='Error: '+e.message}}

// TA helpers
function ma(c,p){return c.map((_,i)=>i<p-1?null:c.slice(i-p+1,i+1).reduce((a,b)=>a+b,0)/p)}
function ema(d,p){const r=[],m=2/(p+1);d.forEach((v,i)=>{i===0?r.push(v):r.push(v*m+r[i-1]*(1-m))});return r}
function rsi(c,p=14){const r=[];let ag=0,al=0;for(let i=0;i<c.length;i++){if(!i){r.push(null);continue}const d=c[i]-c[i-1],g=d>0?d:0,l=d<0?-d:0;if(i<=p){ag+=g/p;al+=l/p;r.push(i<p?null:100-100/(1+ag/(al||.001)))}else{ag=(ag*(p-1)+g)/p;al=(al*(p-1)+l)/p;r.push(100-100/(1+ag/(al||.001)))}}return r}
function macd(c){const e12=ema(c,12),e26=ema(c,26),m=e12.map((v,i)=>v-e26[i]),s=ema(m,9),h=m.map((v,i)=>v-s[i]);return{m,s,h}}
function boll(c,p=20){const mid=ma(c,p),up=[],lo=[];for(let i=0;i<c.length;i++){if(mid[i]===null){up.push(null);lo.push(null);continue}const sl=c.slice(i-p+1,i+1),sd=Math.sqrt(sl.reduce((a,v)=>a+(v-mid[i])**2,0)/p);up.push(mid[i]+2*sd);lo.push(mid[i]-2*sd)}return{mid,up,lo}}

// INDICATORS
async function lind(){const s=$('in-s').value,sel=Array.from($('in-i').selectedOptions).map(o=>o.value);$('in-st').textContent='Loading...';
try{const r=await fb(s,'1d',120),dt=r.map(k=>fd(k[0],'1d')),cl=r.map(k=>+k[4]),oh=r.map(k=>[+k[1],+k[4],+k[3],+k[2]]),v=r.map(k=>+k[5]),vc=r.map(k=>+k[4]>=+k[1]?U+'80':D+'80');
const hasRSI=sel.includes('RSI'),hasMACD=sel.includes('MACD'),hasATR=sel.includes('ATR');let subN=0;if(hasRSI)subN++;if(hasMACD)subN++;if(hasATR)subN++;
const mainH=subN===0?52:subN===1?40:subN===2?34:28,volT=10+mainH+2,volH=8;
const grids=[{left:'8%',right:'4%',top:'8%',height:mainH+'%'},{left:'8%',right:'4%',top:(10+mainH)+'%',height:volH+'%'}];
const xA=[{type:'category',data:dt,gridIndex:0,axisLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:9},splitLine:{show:false}},{type:'category',data:dt,gridIndex:1,axisLine:{lineStyle:{color:G}},axisLabel:{show:false},splitLine:{show:false}}];
const yA=[{type:'value',gridIndex:0,splitLine:{lineStyle:{color:G}},axisLabel:{color:S},scale:true},{type:'value',gridIndex:1,splitLine:{show:false},axisLabel:{show:false},axisLine:{show:false}}];
const ser=[{type:'candlestick',data:oh,itemStyle:{color:U,color0:D,borderColor:U,borderColor0:D}},{type:'bar',data:v.map((x,i)=>({value:x,itemStyle:{color:vc[i]}})),xAxisIndex:1,yAxisIndex:1}];
const dzIdx=[0,1];let gi=2,curTop=10+mainH+volH+2;

// MA overlay
if(sel.includes('MA')){[7,25,99].forEach((p,pi)=>{ser.push({type:'line',data:ma(cl,p),name:'MA'+p,symbol:'none',lineStyle:{width:1.2,color:P[pi]},xAxisIndex:0,yAxisIndex:0})})}
// BOLL overlay
if(sel.includes('BOLL')){const b=boll(cl);ser.push({type:'line',data:b.mid,name:'BOLL Mid',symbol:'none',lineStyle:{width:1,color:'#ffc233'}});ser.push({type:'line',data:b.up,name:'BOLL Upper',symbol:'none',lineStyle:{width:1,type:'dashed',color:'#ffc23380'}});ser.push({type:'line',data:b.lo,name:'BOLL Lower',symbol:'none',lineStyle:{width:1,type:'dashed',color:'#ffc23380'}});ser.push({type:'line',data:b.up,name:'Band',symbol:'none',lineStyle:{width:0},areaStyle:{color:'#ffc23310'},stack:'boll'});ser.push({type:'line',data:b.lo,symbol:'none',lineStyle:{width:0},areaStyle:{color:'#ffc23310'},stack:'boll'})}
// VWAP overlay
if(sel.includes('VWAP')){const vw=vwap(r);ser.push({type:'line',data:vw,name:'VWAP',symbol:'none',lineStyle:{width:2,color:'#ffffff'},xAxisIndex:0,yAxisIndex:0})}
// RSI sub-panel
if(hasRSI){const subH=subN===1?18:14;grids.push({left:'8%',right:'4%',top:curTop+'%',height:subH+'%'});xA.push({type:'category',data:dt,gridIndex:gi,axisLine:{lineStyle:{color:G}},axisLabel:{show:false},splitLine:{show:false}});yA.push({type:'value',gridIndex:gi,min:0,max:100,splitLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:9}});ser.push({type:'line',data:rsi(cl),name:'RSI(14)',symbol:'none',lineStyle:{width:1.5,color:'#7c4dff'},xAxisIndex:gi,yAxisIndex:gi});dzIdx.push(gi);curTop+=subH+2;gi++}
// MACD sub-panel
if(hasMACD){const subH=subN===1?18:14;grids.push({left:'8%',right:'4%',top:curTop+'%',height:subH+'%'});xA.push({type:'category',data:dt,gridIndex:gi,axisLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:9},splitLine:{show:false}});yA.push({type:'value',gridIndex:gi,splitLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:9}});const mc=macd(cl);ser.push({type:'bar',data:mc.h.map(v=>({value:v,itemStyle:{color:v>=0?U+'cc':D+'cc'}})),name:'Hist',xAxisIndex:gi,yAxisIndex:gi});ser.push({type:'line',data:mc.m,name:'MACD',symbol:'none',lineStyle:{width:1.2,color:'#5b8ff9'},xAxisIndex:gi,yAxisIndex:gi});ser.push({type:'line',data:mc.s,name:'Signal',symbol:'none',lineStyle:{width:1.2,color:'#ff6b6b'},xAxisIndex:gi,yAxisIndex:gi});dzIdx.push(gi);gi++}

// ATR sub-panel
if(hasATR){const subH=subN===1?18:14;grids.push({left:'8%',right:'4%',top:curTop+'%',height:subH+'%'});xA.push({type:'category',data:dt,gridIndex:gi,axisLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:9},splitLine:{show:false}});yA.push({type:'value',gridIndex:gi,splitLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:9}});const at=atr(r);ser.push({type:'line',data:at,name:'ATR(14)',symbol:'none',lineStyle:{width:1.5,color:'#ff6b6b'},xAxisIndex:gi,yAxisIndex:gi});dzIdx.push(gi);curTop+=subH+2;gi++}

ic('c-indicators').setOption({backgroundColor:B,animation:false,title:{text:`${s} ‚Äî Indicators`,left:'center',textStyle:{color:T,fontSize:14,fontWeight:700}},tooltip:{trigger:'axis',axisPointer:{type:'cross'},backgroundColor:'#1e1e3d',borderColor:'#2a2a4a',textStyle:{color:T,fontSize:11}},legend:{data:ser.filter(s=>s.name).map(s=>s.name),bottom:0,textStyle:{color:S,fontSize:10}},grid:grids,xAxis:xA,yAxis:yA,series:ser,dataZoom:[{type:'inside',xAxisIndex:dzIdx}]},true);
$('in-st').textContent=`${s} ¬∑ ${sel.join('+')} ¬∑ ${r.length} candles`}catch(e){$('in-st').textContent='Error: '+e.message}}

// OVERLAY
async function lov(){const s1=$('ov-1').value,s2=$('ov-2').value,days=+$('ov-d').value;$('ov-st').textContent='Loading...';
try{const[r1,r2]=await Promise.all([fb(s1,'1d',days),fb(s2,'1d',days)]);
function norm(r){const cl=r.map(k=>+k[4]),f=cl[0];return{dates:r.map(k=>fd(k[0],'1d')),vals:cl.map(v=>((v-f)/f)*100)}}
const a=norm(r1),b=norm(r2);
ic('c-overlay').setOption({backgroundColor:B,animation:false,title:{text:`${s1} vs ${s2} (% change)`,left:'center',textStyle:{color:T,fontSize:14,fontWeight:700}},tooltip:{trigger:'axis',backgroundColor:'#1e1e3d',borderColor:'#2a2a4a',textStyle:{color:T},formatter:function(p){let s=p[0].axisValue+'<br>';p.forEach(i=>{s+=`<span style="color:${i.color}">‚óè</span> ${i.seriesName}: ${i.value!==null?i.value.toFixed(2)+'%':'‚Äî'}<br>`});return s}},legend:{data:[s1,s2],bottom:4,textStyle:{color:S,fontSize:10}},grid:[{left:'8%',right:'4%',top:'10%',height:'78%'}],xAxis:[{type:'category',data:a.dates,axisLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:9},splitLine:{show:false}}],yAxis:[{type:'value',splitLine:{lineStyle:{color:G}},axisLabel:{color:S,formatter:v=>v.toFixed(0)+'%'}}],series:[{name:s1,type:'line',data:a.vals,symbol:'none',lineStyle:{width:2,color:P[0]},areaStyle:{color:{type:'linear',x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:P[0]+'20'},{offset:1,color:'transparent'}]}}},{name:s2,type:'line',data:b.vals,symbol:'none',lineStyle:{width:2,color:P[1]},areaStyle:{color:{type:'linear',x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:P[1]+'20'},{offset:1,color:'transparent'}]}}}],dataZoom:[{type:'inside'}]},true);
const la1=r1[r1.length-1],la2=r2[r2.length-1];const p1=((+la1[4]-+r1[0][4])/+r1[0][4]*100).toFixed(1),p2=((+la2[4]-+r2[0][4])/+r2[0][4]*100).toFixed(1);
$('ov-st').textContent=`${s1}: ${p1>=0?'+':''}${p1}% ¬∑ ${s2}: ${p2>=0?'+':''}${p2}%`}catch(e){$('ov-st').textContent='Error: '+e.message}}

// FUNDAMENTALS (3 modes: standard / dcf / estimates)
function lfun(){const mode=$('fn-m').value;
if(mode==='dcf')lfunDCF();
else if(mode==='estimates')lfunEst();
else lfunStd()}

// Standard ‚Äî bar comparison
function lfunStd(){const years=['2021','2022','2023','2024','2025'];
const data={AAPL:{rev:[365.8,394.3,383.3,391.0,420.5]},MSFT:{rev:[168.1,198.3,211.9,245.1,277.0]},GOOGL:{rev:[257.6,282.8,307.4,350.0,381.0]}};
$('fn-s').style.display='none';
ic('c-fundamentals').setOption({backgroundColor:B,animation:true,title:{text:'Revenue Comparison (Billion USD)',left:'center',textStyle:{color:T,fontSize:14,fontWeight:700}},tooltip:{trigger:'axis',backgroundColor:'#1e1e3d',borderColor:'#2a2a4a',textStyle:{color:T},formatter:function(p){let s=p[0].axisValue+'<br>';p.forEach(i=>{s+=`<span style="color:${i.color}">‚óè</span> ${i.seriesName}: $${i.value}B<br>`});return s}},legend:{data:['AAPL','MSFT','GOOGL'],bottom:4,textStyle:{color:S,fontSize:10}},grid:{left:'8%',right:'4%',top:'14%',bottom:'14%'},xAxis:{type:'category',data:years,axisLine:{lineStyle:{color:G}},axisLabel:{color:S}},yAxis:{type:'value',splitLine:{lineStyle:{color:G}},axisLabel:{color:S,formatter:v=>'$'+v+'B'}},series:[{name:'AAPL',type:'bar',data:data.AAPL.rev,itemStyle:{color:P[0],borderRadius:[4,4,0,0]}},{name:'MSFT',type:'bar',data:data.MSFT.rev,itemStyle:{color:P[1],borderRadius:[4,4,0,0]}},{name:'GOOGL',type:'bar',data:data.GOOGL.rev,itemStyle:{color:P[3],borderRadius:[4,4,0,0]}}]},true);
$('fn-st').textContent='Sample data ‚Äî AAPL vs MSFT vs GOOGL'}

// DCF Gauge ‚Äî sample
function lfunDCF(){$('fn-s').style.display='inline-block';
const sym=$('fn-s').value;
const dcfSample={AAPL:{dcf:198.5,price:178.2},MSFT:{dcf:445.0,price:420.8},GOOGL:{dcf:195.0,price:175.3},TSLA:{dcf:180.0,price:248.5},AMZN:{dcf:210.0,price:192.7},NVDA:{dcf:880.0,price:950.0}};
const d=dcfSample[sym]||{dcf:200,price:180};
const margin=((d.dcf-d.price)/d.dcf*100);const under=margin>0;
const maxV=Math.max(d.dcf,d.price)*1.3;
ic('c-fundamentals').setOption({backgroundColor:B,animation:true,
title:{text:`${sym} ‚Äî DCF Valuation`,left:'center',top:10,textStyle:{color:T,fontSize:15,fontWeight:700}},
series:[{type:'gauge',center:['50%','60%'],radius:'80%',min:0,max:Math.round(maxV),
progress:{show:true,width:22,itemStyle:{color:under?U:D}},
pointer:{show:true,length:'60%',width:6,itemStyle:{color:'#fff'}},
axisLine:{lineStyle:{width:22,color:[[d.dcf/maxV,under?'#1a3a2a':'#3a1a2a'],[1,'#1a1a35']]}},
axisTick:{distance:-28,lineStyle:{color:'#444',width:1}},
splitLine:{distance:-32,lineStyle:{color:'#666',width:2}},
axisLabel:{color:S,fontSize:11,distance:-18,formatter:v=>'$'+Math.round(v)},
anchor:{show:true,size:16,itemStyle:{borderWidth:4,borderColor:under?U:D,color:'#1a1a35'}},
detail:{valueAnimation:true,formatter:v=>'$'+v.toFixed(2),color:T,fontSize:28,fontWeight:700,offsetCenter:[0,'30%']},
title:{show:true,offsetCenter:[0,'46%'],color:S,fontSize:13},
data:[{value:d.price,name:'Stock Price'}],
markPoint:{data:[{x:'50%',y:'82%',symbol:'pin',symbolSize:0,label:{show:true,formatter:`DCF: $${d.dcf.toFixed(2)}`,color:under?U:D,fontSize:14,fontWeight:600}}]}
}]},true);
const tag=under?`Undervalued by ${margin.toFixed(1)}%`:`Overvalued by ${Math.abs(margin).toFixed(1)}%`;
$('fn-st').textContent=`${sym} ‚Äî DCF: $${d.dcf} | Price: $${d.price} | ${tag} (sample data)`}

// Analyst Estimates ‚Äî sample
function lfunEst(){$('fn-s').style.display='inline-block';
const sym=$('fn-s').value;
const estSample={AAPL:{actual:[6.11,6.14,6.42,6.97],est:[7.35,7.80,8.15],years:['2022','2023','2024','2025','2026E','2027E','2028E']},
MSFT:{actual:[9.65,11.07,11.80,13.15],est:[14.50,16.20,17.80],years:['2022','2023','2024','2025','2026E','2027E','2028E']},
GOOGL:{actual:[4.56,5.80,6.52,7.88],est:[8.75,9.60,10.40],years:['2022','2023','2024','2025','2026E','2027E','2028E']},
TSLA:{actual:[1.07,3.12,2.48,2.10],est:[2.85,3.90,5.20],years:['2022','2023','2024','2025','2026E','2027E','2028E']},
AMZN:{actual:[-.27,1.29,2.90,4.47],est:[5.80,7.10,8.50],years:['2022','2023','2024','2025','2026E','2027E','2028E']},
NVDA:{actual:[1.74,4.02,12.96,29.04],est:[35.00,38.50,42.00],years:['2022','2023','2024','2025','2026E','2027E','2028E']}};
const d=estSample[sym]||estSample.AAPL;
const allV=[...d.actual,...d.est];
ic('c-fundamentals').setOption({backgroundColor:B,animation:true,
title:{text:`${sym} ‚Äî EPS: Actual vs Estimates`,left:'center',top:8,textStyle:{color:T,fontSize:15,fontWeight:700}},
tooltip:{trigger:'axis',backgroundColor:'#1e1e3d',borderColor:'#2a2a4a',textStyle:{color:T},formatter:p=>{let s=p[0].axisValue+'<br>';p.forEach(i=>{if(i.value!=null)s+=`<span style="color:${i.color}">‚óè</span> ${i.seriesName}: $${i.value.toFixed(2)}<br>`});return s}},
legend:{data:['Actual EPS','Estimated EPS'],bottom:4,textStyle:{color:S,fontSize:10}},
grid:{left:'10%',right:'6%',top:'16%',bottom:'14%'},
xAxis:{type:'category',data:d.years,axisLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:11},splitLine:{show:false}},
yAxis:{type:'value',splitLine:{lineStyle:{color:G}},axisLabel:{color:S,formatter:v=>'$'+v.toFixed(2)}},
series:[
{name:'Actual EPS',type:'bar',data:[...d.actual,...d.est.map(()=>null)],itemStyle:{color:U,borderRadius:[4,4,0,0]},barWidth:'30%'},
{name:'Estimated EPS',type:'bar',data:[...d.actual.map(()=>null),...d.est],itemStyle:{color:'#5b8ff980',borderColor:'#5b8ff9',borderWidth:1,borderType:'dashed',borderRadius:[4,4,0,0]},barWidth:'30%'}
]},true);
$('fn-st').textContent=`${sym} EPS ‚Äî ${d.actual.length} actual + ${d.est.length} estimates (sample data)`}

// Show/hide symbol selector when mode changes
$('fn-m')?.addEventListener('change',function(){
  const m=this.value;$('fn-s').style.display=m==='standard'?'none':'inline-block';
})

// CRYPTO SECTORS MAP
const CSEC={BTC:'Layer 1',ETH:'Layer 1',SOL:'Layer 1',ADA:'Layer 1',AVAX:'Layer 1',DOT:'Layer 1',NEAR:'Layer 1',SUI:'Layer 1',APT:'Layer 1',TON:'Layer 1',ATOM:'Layer 1',ICP:'Layer 1',ALGO:'Layer 1',HBAR:'Layer 1',FTM:'Layer 1',SEI:'Layer 1',TIA:'Layer 1',INJ:'Layer 1',KAS:'Layer 1',
ARB:'Layer 2',OP:'Layer 2',MATIC:'Layer 2',POL:'Layer 2',STRK:'Layer 2',MANTA:'Layer 2',IMX:'Layer 2',MNT:'Layer 2',ZK:'Layer 2',
UNI:'DeFi',AAVE:'DeFi',MKR:'DeFi',CRV:'DeFi',DYDX:'DeFi',COMP:'DeFi',SNX:'DeFi',SUSHI:'DeFi',LDO:'DeFi',PENDLE:'DeFi',JUP:'DeFi',CAKE:'DeFi',RUNE:'DeFi',ENA:'DeFi',
FET:'AI',RENDER:'AI',TAO:'AI',AGIX:'AI',OCEAN:'AI',WLD:'AI',AKT:'AI',RNDR:'AI',
AXS:'Gaming',SAND:'Gaming',MANA:'Gaming',GALA:'Gaming',ENJ:'Gaming',BEAM:'Gaming',PIXEL:'Gaming',RON:'Gaming',
DOGE:'Meme',SHIB:'Meme',PEPE:'Meme',FLOKI:'Meme',WIF:'Meme',BONK:'Meme',NEIRO:'Meme',NOT:'Meme',DOGS:'Meme',BOME:'Meme',PEOPLE:'Meme',TURBO:'Meme',
LINK:'Infra',GRT:'Infra',FIL:'Infra',AR:'Infra',THETA:'Infra',ANKR:'Infra',PYTH:'Infra',STX:'Infra',W:'Infra',
BNB:'Exchange',OKB:'Exchange',CRO:'Exchange',GT:'Exchange',
XRP:'Payment',XLM:'Payment',LTC:'Payment',BCH:'Payment'};
const EXCL=new Set(['USDT','USDC','DAI','BUSD','TUSD','USDP','FDUSD','USDD','WBTC','WETH','STETH','CBETH','RETH','PAXG']);
function cBase(s){const u=s.toUpperCase();if(u.endsWith('USDT'))return u.slice(0,-4);return u}
function cChg(c){if(c>=5)return'#00d4aa';if(c>=2)return'#33b88a';if(c>=.5)return'#4a8a6a';if(c>-.5)return'#4a4a6a';if(c>-2)return'#8a4a5a';if(c>-5)return'#b83353';return'#ff4757'}

// HEATMAP ‚Äî Crypto Sector Treemap
async function lhm(){$('hm-st').textContent='Loading from Binance...';
try{const lim=+$('hm-l').value,minV=+$('hm-v').value;
const res=await(await fetch('https://api.binance.com/api/v3/ticker/24hr')).json();
let items=res.filter(t=>{if(!t.symbol.endsWith('USDT'))return false;const b=cBase(t.symbol);if(EXCL.has(b))return false;return parseFloat(t.quoteVolume||'0')>=minV}).map(t=>{const b=cBase(t.symbol);return{code:b,chg:parseFloat(t.priceChangePercent||'0'),vol:parseFloat(t.quoteVolume||'0'),price:parseFloat(t.lastPrice||'0'),sector:CSEC[b]||'Other'}}).sort((a,b)=>b.vol-a.vol).slice(0,lim);

// Group by sector
const sm=new Map();items.forEach(i=>{if(!sm.has(i.sector))sm.set(i.sector,[]);sm.get(i.sector).push(i)});
const tree=[...sm.entries()].map(([sec,stocks])=>({name:sec,children:stocks.map(s=>({name:s.code,value:s.vol,itemStyle:{color:cChg(s.chg),borderColor:B,borderWidth:1},_d:{price:s.price,chg:s.chg,vol:s.vol,sector:s.sector}}))}));

ic('c-heatmap').setOption({backgroundColor:B,title:{text:'Crypto Sector Heatmap (24h Change)',left:'center',top:8,textStyle:{color:T,fontSize:15,fontWeight:700}},
tooltip:{formatter:i=>{const d=i.data?._d;if(!d)return'<b>'+i.name+'</b>';const s=d.chg>=0?'+':'';return`<b>${i.name}</b><br>Price: $${d.price.toLocaleString()}<br>Change: <span style="color:${d.chg>=0?U:D}">${s}${d.chg.toFixed(2)}%</span><br>24h Vol: $${(d.vol/1e6).toFixed(1)}M<br>${d.sector}`}},
series:[{type:'treemap',data:tree,width:'94%',height:'84%',top:44,left:'center',roam:false,nodeClick:false,breadcrumb:{show:false},
levels:[{itemStyle:{borderColor:'#333',borderWidth:0,gapWidth:2}},{itemStyle:{borderColor:'#555',borderWidth:2,gapWidth:2},upperLabel:{show:true,height:20,color:S,fontSize:11,fontWeight:'bold',backgroundColor:'transparent'}},{itemStyle:{borderColor:B,borderWidth:1,gapWidth:1},label:{show:true,formatter:p=>{const d=p.data?._d;if(!d)return p.name;const s=d.chg>=0?'+':'';return'{name|'+p.name+'}\n{chg|'+s+d.chg.toFixed(1)+'%}'},rich:{name:{fontSize:12,color:'#fff',fontWeight:'bold',lineHeight:16},chg:{fontSize:10,color:'#ddd',lineHeight:14}},align:'center',verticalAlign:'middle'}}]}]},true);
$('hm-st').textContent=`${items.length} tokens ¬∑ ${sm.size} sectors ¬∑ live from Binance`}catch(e){$('hm-st').textContent='Error: '+e.message}}

// CORRELATION MATRIX
async function lcr(){$('cr-st').textContent='Calculating...';
try{const syms=[...new Set([$('cr-a1').value,$('cr-a2').value,$('cr-a3').value].concat($('cr-a4').value?[$('cr-a4').value]:[]))];
if(syms.length<2){$('cr-st').textContent='‚ö†Ô∏è Select at least 2 different assets';return}
const days=+$('cr-d').value;const names=syms.map(s=>cBase(s));
// Fetch daily klines for all
const all=await Promise.all(syms.map(s=>fb(s,'1d',days)));
// Compute daily log returns
const rets=all.map(kl=>{const cl=kl.map(k=>+k[4]);const r=[];for(let i=1;i<cl.length;i++)r.push(cl[i-1]===0?0:Math.log(cl[i]/cl[i-1]));return r});
// Align lengths
const minLen=Math.min(...rets.map(r=>r.length));const aligned=rets.map(r=>r.slice(r.length-minLen));
// Pearson correlation
function pcorr(x,y){const n=x.length;let sx=0,sy=0,sxy=0,sx2=0,sy2=0;for(let i=0;i<n;i++){sx+=x[i];sy+=y[i];sxy+=x[i]*y[i];sx2+=x[i]*x[i];sy2+=y[i]*y[i]}const num=n*sxy-sx*sy;const den=Math.sqrt((n*sx2-sx*sx)*(n*sy2-sy*sy));return den===0?0:num/den}
const n=syms.length;const mat=[];for(let i=0;i<n;i++){mat[i]=[];for(let j=0;j<n;j++){mat[i][j]=i===j?1:Math.round(pcorr(aligned[i],aligned[j])*1000)/1000}}
// Build heatmap data [x, y, value]
const hd=[];for(let i=0;i<n;i++)for(let j=0;j<n;j++)hd.push([j,n-1-i,mat[i][j]]);

ic('c-corr').setOption({backgroundColor:B,title:{text:`Correlation Matrix (${days}d daily returns)`,left:'center',top:8,textStyle:{color:T,fontSize:15,fontWeight:700}},
tooltip:{position:'top',formatter:p=>{const[x,ry,v]=p.data;const y=n-1-ry;if(x===y)return`<b>${names[x]}</b> (self)`;const s=v>=0?'+':'';const c=v>=0?U:D;return`<b>${names[y]}</b> vs <b>${names[x]}</b><br>Correlation: <span style="color:${c}">${s}${v.toFixed(3)}</span>`}},
grid:{left:80,right:80,top:50,bottom:80},
xAxis:{type:'category',data:names,position:'bottom',axisLine:{show:false},axisTick:{show:false},axisLabel:{color:S,fontSize:12},splitArea:{show:false}},
yAxis:{type:'category',data:[...names].reverse(),axisLine:{show:false},axisTick:{show:false},axisLabel:{color:S,fontSize:12},splitArea:{show:false}},
visualMap:{min:-1,max:1,calculable:false,orient:'vertical',right:6,top:'center',inRange:{color:[D,'#6a3040','#4a4a6a','#3a6a50',U]},textStyle:{color:S},text:['+1','-1']},
series:[{type:'heatmap',data:hd,label:{show:true,formatter:p=>p.data[2]===1?'1.00':p.data[2].toFixed(2),color:T,fontSize:n>5?10:13},emphasis:{itemStyle:{borderColor:'#fff',borderWidth:2}},itemStyle:{borderColor:B,borderWidth:2}}]},true);
$('cr-st').textContent=`${names.join(' √ó ')} ¬∑ ${minLen} days ¬∑ Pearson r`}catch(e){$('cr-st').textContent='Error: '+e.message}}

// WRB SCORING
function detectWRB(klines,lb=5,sens=1.5){
const bars=klines.map(k=>({o:+k[1],h:+k[2],l:+k[3],c:+k[4],v:+k[5],t:k[0]}));
const wrb=[],gaps=[];
for(let i=lb;i<bars.length;i++){
const b=bars[i],body=Math.abs(b.c-b.o);
let avgBody=0;for(let j=i-lb;j<i;j++)avgBody+=Math.abs(bars[j].c-bars[j].o);avgBody/=lb;
if(body>avgBody*sens){
const bull=b.c>b.o;wrb.push({idx:i,bull,body});
// Check for hidden gap (no overlap with prev candle body)
const prev=bars[i-1],prevHi=Math.max(prev.o,prev.c),prevLo=Math.min(prev.o,prev.c);
const curHi=Math.max(b.o,b.c),curLo=Math.min(b.o,b.c);
if(curLo>prevHi||curHi<prevLo){
// Check if gap zone still active (not filled by later candles)
const gapTop=bull?curLo:curHi,gapBot=bull?prevHi:prevLo;
let filled=false,pro=false;
// Simple pro check: volume > 1.5x avg and strong direction
const avgVol=bars.slice(Math.max(0,i-20),i).reduce((a,x)=>a+x.v,0)/Math.min(20,i);
if(b.v>avgVol*1.2&&body>avgBody*2)pro=true;
// Check if filled by subsequent bars
for(let j=i+1;j<bars.length;j++){const fb=bars[j];if(bull&&fb.l<gapBot){filled=true;break}if(!bull&&fb.h>gapTop){filled=true;break}}
gaps.push({idx:i,bull,top:Math.max(gapTop,gapBot),bot:Math.min(gapTop,gapBot),filled,pro})
}}}
return{wrb,gaps,bars}}

async function lwrb(){const s=$('wrb-s').value,t=$('wrb-t').value,l=+$('wrb-l').value;$('wrb-st').textContent='Analyzing...';
try{const r=await fb(s,t,l),dt=r.map(k=>fd(k[0],t)),oh=r.map(k=>[+k[1],+k[4],+k[3],+k[2]]),v=r.map(k=>+k[5]),vc=r.map(k=>+k[4]>=+k[1]?U+'80':D+'80');
const w=detectWRB(r);
// Mark WRB candles
const wrbMark=w.wrb.map(x=>({xAxis:dt[x.idx],yAxis:w.bars[x.idx].h,symbol:'triangle',symbolSize:8,itemStyle:{color:x.bull?U:D}}));
// Mark area for active gap zones
const gapAreas=w.gaps.filter(g=>!g.filled).map(g=>[{xAxis:dt[g.idx],yAxis:g.top,itemStyle:{color:g.pro?'#ffc23325':'#5b8ff918'}},{xAxis:dt[Math.min(g.idx+30,dt.length-1)],yAxis:g.bot}]);
// Pro signals ‚Äî diamond markers
const proMarks=w.gaps.filter(g=>g.pro&&!g.filled).map(g=>({xAxis:dt[g.idx],yAxis:g.bull?w.bars[g.idx].l*0.998:w.bars[g.idx].h*1.002,symbol:'diamond',symbolSize:12,itemStyle:{color:'#ffc233',borderColor:'#fff',borderWidth:1}}));

ic('c-wrb').setOption({backgroundColor:B,animation:false,
title:{text:`${s} ‚Äî ${t} WRB/HG Analysis`,left:'center',textStyle:{color:T,fontSize:15,fontWeight:700}},
tooltip:{trigger:'axis',axisPointer:{type:'cross'},backgroundColor:'#1e1e3d',borderColor:'#2a2a4a',textStyle:{color:T}},
legend:{data:['WRB','Pro Signal'],bottom:4,right:16,textStyle:{color:S,fontSize:10}},
grid:[{left:'8%',right:'4%',top:'10%',height:'54%'},{left:'8%',right:'4%',top:'68%',height:'14%'}],
xAxis:[{type:'category',data:dt,gridIndex:0,axisLine:{lineStyle:{color:G}},axisLabel:{color:S,fontSize:9},splitLine:{show:false}},
{type:'category',data:dt,gridIndex:1,axisLine:{lineStyle:{color:G}},axisLabel:{show:false},splitLine:{show:false}}],
yAxis:[{type:'value',gridIndex:0,splitLine:{lineStyle:{color:G}},axisLabel:{color:S},scale:true},
{type:'value',gridIndex:1,splitLine:{show:false},axisLabel:{show:false},axisLine:{show:false}}],
series:[
{type:'candlestick',data:oh,itemStyle:{color:U,color0:D,borderColor:U,borderColor0:D},
markPoint:{data:wrbMark,label:{show:false}},
markArea:{silent:true,data:gapAreas}},
{name:'WRB',type:'scatter',data:[],symbol:'triangle',itemStyle:{color:'#5b8ff9'}},
{name:'Pro Signal',type:'scatter',data:proMarks.map(p=>({value:[p.xAxis,p.yAxis],symbol:p.symbol,symbolSize:p.symbolSize,itemStyle:p.itemStyle})),symbol:'diamond',symbolSize:12,itemStyle:{color:'#ffc233'}},
{type:'bar',data:v.map((x,i)=>({value:x,itemStyle:{color:vc[i]}})),xAxisIndex:1,yAxisIndex:1}
],
dataZoom:[{type:'inside',xAxisIndex:[0,1]}]
},true);

const activeG=w.gaps.filter(g=>!g.filled).length,proG=w.gaps.filter(g=>g.pro&&!g.filled).length;
$('wrb-st').textContent=`WRB: ${w.wrb.length} | Gaps: ${w.gaps.length} (Active: ${activeG}) | Pro: ${proG} ¬∑ ${r.length} candles`
}catch(e){$('wrb-st').textContent='Error: '+e.message}}

function $(id){return document.getElementById(id)}
// Auto-load first tab
lkl();
</script>
</body>
</html>
